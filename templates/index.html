<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Dashboard de Procesamiento de Videos</title>
<!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<style>
body {
    background-color: #f8f9fa;
}
h1, h2 { color: #2c3e50; }
.progress { height: 25px; }
.card-task { margin-bottom: 15px; }
.video-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; margin-bottom: 10px; border-radius: 8px; background-color: #e9ecef; }
.video-actions button { margin-left: 5px; }
</style>
</head>
<body>

<div class="container my-4">
    <h1 class="text-center mb-4">Dashboard de Procesamiento de Videos</h1>

    <!-- 1. Subir Video -->
    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-primary text-white">
            Subir Video Base
        </div>
        <div class="card-body">
            <input type="file" id="fileUpload" class="form-control mb-2">
            <button id="uploadBtn" class="btn btn-success">Subir Video</button>
            <div id="uploadStatus" class="mt-2"></div>
        </div>
    </div>

    <!-- 2. Cortes por Segmentos -->
    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-info text-white">
            Cortes por Segmentos
        </div>
        <div class="card-body">
            <label>Video base:</label>
            <select id="splitVideoSelect" class="form-select mb-2"></select>
            <label>Inicio (s):</label>
            <input type="number" id="splitStart" value="0" class="form-control mb-2">
            <label>Duración por corte (s):</label>
            <input type="number" id="splitDuration" value="29" class="form-control mb-2">
            <button id="startSplitBtn" class="btn btn-primary">Iniciar Corte por Segmentos</button>
        </div>
    </div>

    <!-- 3. Corte Único -->
    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-warning text-white">
            Corte Único
        </div>
        <div class="card-body">
            <label>Video base:</label>
            <select id="cutVideoSelect" class="form-select mb-2"></select>
            <label>Inicio (s):</label>
            <input type="number" id="cutStart" value="0" class="form-control mb-2">
            <label>Duración (s):</label>
            <input type="number" id="cutDuration" value="29" class="form-control mb-2">
            <button id="startCutBtn" class="btn btn-warning">Iniciar Corte Único</button>
        </div>
    </div>

    <!-- 4. Progreso de Tareas -->
    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-secondary text-white">
            Progreso de Tareas
        </div>
        <div class="card-body" id="tasksContainer">
            <!-- Las tareas activas aparecerán aquí -->
        </div>
    </div>

    <!-- 5. Videos Procesados -->
    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-success text-white">
            Videos Procesados
        </div>
        <div class="card-body" id="processedContainer">
            <!-- Los videos procesados aparecerán aquí -->
        </div>
    </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
let taskIntervals = {};

// Refrescar selects de videos
function refreshVideoSelects() {
    $.get('/api/files', function(data) {
        $('#splitVideoSelect, #cutVideoSelect').empty();
        data.video_files.forEach(v => {
            $('#splitVideoSelect, #cutVideoSelect').append(`<option value="${v}">${v}</option>`);
        });
        refreshProcessedList();
    });
}

// Refrescar lista de videos procesados
function refreshProcessedList() {
    $.get('/api/files', function(data){
        $('#processedContainer').empty();
        data.processed_files.forEach(f => {
            $('#processedContainer').append(`
                <div class="video-item">
                    <div>${f}</div>
                    <div class="video-actions">
                        <button class="btn btn-sm btn-outline-primary" onclick="downloadFile('${f}')">Descargar</button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteProcessed('${f}')">Eliminar</button>
                    </div>
                </div>
            `);
        });
    });
}

// Descargar video
function downloadFile(filename){ window.location = `/download/${filename}`; }

// Eliminar video procesado
function deleteProcessed(filename){
    $.post(`/delete_processed/${filename}`, function(res){
        if(res.ok) refreshProcessedList();
        else alert(res.error);
    });
}

// Subir archivo
// Subir archivo con barra de progreso
$('#uploadBtn').click(function(){
    let fileInput = $('#fileUpload')[0];
    if(fileInput.files.length === 0) return alert('Selecciona un archivo');
    
    let formData = new FormData();
    formData.append('file', fileInput.files[0]);

    // Crear barra de progreso
    $('#uploadStatus').html(`
        <div class="progress">
            <div id="uploadProgressBar" class="progress-bar progress-bar-striped progress-bar-animated" style="width:0%">0%</div>
        </div>
    `);

    $.ajax({
        url: '/upload',
        type: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        xhr: function(){
            let xhr = new window.XMLHttpRequest();
            // Progreso de subida
            xhr.upload.addEventListener("progress", function(evt){
                if(evt.lengthComputable){
                    let percent = Math.round((evt.loaded / evt.total) * 100);
                    $('#uploadProgressBar').css('width', percent + '%').text(percent + '%');
                }
            }, false);
            return xhr;
        },
        success: function(res){
            if(res.ok){
                $('#uploadStatus').html(`<div class="alert alert-success">✅ Subido: ${res.filename}</div>`);
                refreshVideoSelects();
            }else{
                $('#uploadStatus').html(`<div class="alert alert-danger">❌ Error: ${res.error}</div>`);
            }
        },
        error: function(){
            $('#uploadStatus').html(`<div class="alert alert-danger">❌ Error al subir archivo</div>`);
        }
    });
});


// Iniciar Split
$('#startSplitBtn').click(function(){
    let video_file = $('#splitVideoSelect').val();
    let start_time = $('#splitStart').val();
    let segment_duration = $('#splitDuration').val();

    $.ajax({
        url: '/start_split',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            video_file: video_file,
            start_time: start_time,
            segment_duration: segment_duration
        }),
        success: function(res){
            if(res.ok) addTaskBox(res.task_id, res.video_file);
            else alert(res.error);
        }
    });
});

// Iniciar Corte Único
$('#startCutBtn').click(function(){
    let video_file = $('#cutVideoSelect').val();
    let start_time = $('#cutStart').val();
    let duration = $('#cutDuration').val();

    $.ajax({
        url: '/start_cut',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            video_file: video_file,
            start_time: start_time,
            duration: duration
        }),
        success: function(res){
            if(res.ok) addTaskBox(res.task_id, res.video_file);
            else alert(res.error);
        }
    });
});


// Agregar tarea
function addTaskBox(task_id, video_file){
    if($('#task_' + task_id).length) return;
    $('#tasksContainer').append(`
        <div class="card card-task" id="task_${task_id}">
            <div class="card-body">
                <h5 class="card-title">${video_file}</h5>
                <div class="progress mb-2">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" id="progress_${task_id}" style="width:0%">0%</div>
                </div>
                <div id="status_${task_id}">Iniciando...</div>
            </div>
        </div>
    `);
    taskIntervals[task_id] = setInterval(()=>updateTaskProgress(task_id), 1000);
}

// Actualizar progreso de tarea
function updateTaskProgress(task_id){
    $.get(`/task_progress/${task_id}`, function(res){
        if(!res.status) return;
        let percent = 0;
        if(res.total_segments) percent = Math.round((res.completed_segments/res.total_segments)*100);
        $('#progress_' + task_id).css('width', percent + '%').text(percent + '%');
        $('#status_' + task_id).text(res.current_action + (res.status==='completed'?' ✅':res.status==='error'?' ❌':''));
        if(res.status==='completed' || res.status==='error'){
            clearInterval(taskIntervals[task_id]);
            refreshProcessedList();
        }
    });
}

// Inicializar
refreshVideoSelects();
</script>

</body>
</html>
